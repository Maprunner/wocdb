// Version 0.1.0 2015-07-21T18:21:55;
var wocdb=function(a,b){"use strict";function c(){var a,b,c,d;return wocdb.router=new wocdb.WocdbRouter,wocdb.utils.hijackLinks(),wocdb.dispatcher=_.clone(Backbone.Events),wocdb.races=new wocdb.Races,wocdb.wocs=new wocdb.Wocs,wocdb.raceResult=new wocdb.RaceResult,wocdb.person=new wocdb.Person,wocdb.activeWOC=new wocdb.ActiveWOC,wocdb.masterView=new wocdb.MasterView,wocdb.activeWOCView=new wocdb.ActiveWOCView({model:wocdb.activeWOC}),wocdb.activeResultView=new wocdb.RaceResultView({collection:wocdb.raceResult}),wocdb.activeResultHeaderView=new wocdb.RaceResultHeaderView({collection:wocdb.raceResult}),wocdb.raceMenuView=new wocdb.RaceMenuView({model:wocdb.activeWOC}),wocdb.personView=new wocdb.PersonView({collection:wocdb.person}),wocdb.wocDbView=new wocdb.WOCDBView({collection:wocdb.wocs}),Backbone.history.start({pushState:!0,root:"/wocdb",silent:!0}),wocdb.config.bootstrapRaceResult?(wocdb.dispatcher.trigger("display:page","single-woc-page"),b=wocdb.utils.getType(parseInt(wocdb.config.bootstrapRaceResult[0].wocid,10)),a=parseInt(wocdb.config.bootstrapRaceResult[0].year,10),c=parseInt(wocdb.config.bootstrapRaceResult[0].raceid,10),void wocdb.dispatcher.trigger("startup:race",{type:b,year:a,raceid:c})):wocdb.config.bootstrapPerson?(wocdb.dispatcher.trigger("display:page","person-page"),d=parseInt(wocdb.config.bootstrapPerson[0].personid,10),void wocdb.dispatcher.trigger("startup:person",{personid:d})):void wocdb.dispatcher.trigger("display:page","all-wocs-page")}return{init:c}}(window,window.jQuery);!function(){"use strict";wocdb.ActiveWOC=Backbone.Model.extend({initialize:function(){wocdb.dispatcher.on("change:activeWOC",this.setActiveWOC,this)},setActiveWOC:function(a){this.set(a)}})}(),function(){"use strict";wocdb.Woc=Backbone.Model.extend({initialize:function(){this.attributes.type="W"===this.attributes.type?"WOC":"JWOC",this.attributes.raceids=this.attributes.raceids.split(",").map(function(a){return parseInt(a,10)}),this.attributes.classes=this.attributes.classes.split(","),this.attributes.races=this.attributes.races.split(",")}})}(),function(){"use strict";wocdb.Race=Backbone.Model.extend({initialize:function(){this.set("raceLowerCase",this.attributes.race.toLowerCase()),this.set("genderLowerCase",this.attributes.gender.toLowerCase())}})}(),function(){"use strict";wocdb.Result=Backbone.Model.extend({initialize:function(){this.attributes.flag=wocdb.utils.getFlagFile(this.attributes.country),this.attributes["final"]>0&&this.attributes.position<4&&(this.attributes.position='<img src="'+wocdb.config.url+"img/"+this.attributes.position+'.svg">'),this.attributes.percentdown=parseFloat(this.attributes.percentdown).toFixed(1),this.attributes.gender=this.attributes["class"]}})}(),function(){"use strict";wocdb.Wocs=Backbone.Collection.extend({initialize:function(){this.activeWOCIndex=null,wocdb.dispatcher.on("click:showWOCID",this.setActiveWOCID,this),wocdb.dispatcher.on("click:showNextWOC",this.showNextWOC,this),wocdb.dispatcher.on("click:showPreviousWOC",this.showPreviousWOC,this),wocdb.dispatcher.on("startup:race",this.setActiveWOCAtStart,this),this.reset(wocdb.config.bootstrapWocs),this.createRaceCollection()},model:wocdb.Woc,setActiveWOCID:function(a){var b,c;b=this.findWhere({id:a.wocid}),this.activeWocIndex=this.indexOf(b),c=this.models[this.activeWocIndex].attributes,c.startUpRaceID=a.raceid,wocdb.dispatcher.trigger("change:activeWOC",c)},setActiveWOCAtStart:function(a){var b,c;b=this.findWhere({type:a.type,year:a.year}),this.activeWocIndex=this.indexOf(b),c=this.models[this.activeWocIndex].attributes,c.startUpRaceID=a.raceid,wocdb.dispatcher.trigger("change:activeWOC",c)},setActiveWOCIndex:function(a){var b;this.activeWOCIndex=a,b=this.models[a].attributes,wocdb.dispatcher.trigger("change:activeWOC",b)},showPreviousWOC:function(){var a;a=this.activeWOCIndex+1,a>=this.models.length&&(a=0),this.setActiveWOCIndex(a)},showNextWOC:function(){var a;a=this.activeWOCIndex-1,0>a&&(a=this.models.length-1),this.setActiveWOCIndex(a)},createRaceCollection:function(){var a,b,c,d;for(wocdb.races.reset(),c=0;c<this.models.length;c+=1)for(b=this.models[c].attributes,d=0;d<b.raceids.length;d+=1)a={year:b.year,type:b.type,wocid:b.id,gender:b.classes[d],raceid:b.raceids[d],race:b.races[d]},wocdb.races.add(a)}})}(),function(){"use strict";wocdb.Races=Backbone.Collection.extend({model:wocdb.Race,getRaceInfo:function(a){var b;return b=this.findWhere({raceid:a}),b.attributes},getRaceID:function(a,b,c,d){var e;return e=this.findWhere({type:a,year:parseInt(b,10),genderLowerCase:c,raceLowerCase:d}),e?e.attributes.raceid:0}})}(),function(){"use strict";wocdb.RaceResult=Backbone.Collection.extend({initialize:function(){wocdb.dispatcher.on("change:activeWOC",this.setRaceAtWOC,this),wocdb.dispatcher.on("click:showNextRaceAtWOC",this.getNextRaceAtWOC,this),wocdb.dispatcher.on("click:showPreviousRaceAtWOC",this.getPreviousRaceAtWOC,this),this.reset(wocdb.config.bootstrapRaceResult),this.listenTo(this,"update",this.announceNewRaceID),this.raceIndex=null,this.active={}},url:function(){return wocdb.config.url+this.active.type.toLowerCase()+"/"+this.active.year+"/"+this.active.classes[this.raceIndex].toLowerCase()+"/"+this.active.races[this.raceIndex].toLowerCase()},model:wocdb.Result,announceNewRaceID:function(){wocdb.router.navigate(this.active.type.toLowerCase()+"/"+this.active.year+"/"+this.active.classes[this.raceIndex].toLowerCase()+"/"+this.active.races[this.raceIndex].toLowerCase()),wocdb.dispatcher.trigger("change:raceid",this.active.raceids[this.raceIndex])},setRaceAtWOC:function(a){this.raceIndex=0,this.active=a,a.startUpRaceID&&(this.raceIndex=_.indexOf(a.raceids,a.startUpRaceID),-1===this.raceIndex&&(this.raceIndex=0),this.announceNewRaceID()),this.length>0?this.models[0].raceid!==this.active.raceids[this.raceIndex]&&this.loadRace():this.loadRace()},getPreviousRaceAtWOC:function(){this.raceIndex-=1,this.raceIndex<0&&(this.raceIndex=this.active.races.length-1),this.loadRace()},getNextRaceAtWOC:function(){this.raceIndex+=1,this.raceIndex>=this.active.races.length&&(this.raceIndex=0),this.loadRace()},getResultByRaceID:function(a){this.raceIndex=_.indexOf(this.active.raceids,a),-1===this.raceIndex&&(this.raceIndex=0),this.loadRace()},loadRace:function(){this.reset(),this.fetch()}})}(),function(){"use strict";wocdb.ActiveWOCView=Backbone.View.extend({el:"#woc-summary-table",events:{"click #next-woc":"showNextWOC","click #prev-woc":"showPreviousWOC"},summaryTemplate:_.template($("#woc-summary-tmpl").html()),initialize:function(){this.listenTo(this.model,"change",this.render)},showNextWOC:function(){wocdb.dispatcher.trigger("click:showNextWOC")},showPreviousWOC:function(){wocdb.dispatcher.trigger("click:showPreviousWOC")},render:function(){return this.$el.html(this.summaryTemplate(this.model.attributes)),this}})}(),function(){"use strict";wocdb.WOCDBView=Backbone.View.extend({el:"#all-wocs-page",events:{"click #wocs-table tbody tr":"selectWOC"},initialize:function(){this.listenTo(this.collection,"reset",this.render),this.render()},render:function(){this.wocsTable=$("#wocs-table").DataTable({data:this.collection.models,columns:[{data:function(a){return a.get("id")},visible:!1},{data:function(a){return a.get("year")},title:"Year"},{data:function(a){return a.get("type")},title:"Type"},{data:function(a){return a.get("country")},title:"Country"},{data:function(a){return a.get("location")},title:"Location"},{data:function(a){return a.get("dates")},title:"Dates"},{data:function(a){return a.get("countries")},title:"Countries"},{data:function(a){return a.get("runners")},title:"Runners"}],createdRow:function(a,b,c){$(a).attr("id",c)},lengthMenu:[[10,20,-1],[10,20,"All"]],order:[[1,"desc"],[2,"desc"]],autoWidth:!0,searching:!1,columnDefs:[{className:"dt-center",targets:[1,2,6,7]}]})},selectWOC:function(a){var b;wocdb.dispatcher.trigger("display:page","single-woc-page"),b=parseInt(a.currentTarget.id,10),this.collection.setActiveWOCIndex(b)}})}(),function(){"use strict";wocdb.ResultView=Backbone.View.extend({model:wocdb.Result,tagName:"tr",template:_.template($("#race-result-tmpl").html()),render:function(){return this.$el.html(this.template(this.model.attributes)).attr("id",this.model.attributes.personid),this}})}(),function(){"use strict";var a={getVenue:function(a){var b;return b=wocdb.wocs.findWhere({id:a}),b?b.attributes.country:""},getType:function(a){return 1e3>a?"WOC":"JWOC"},abbrevList:["ARG","AUS","AUT","AZE","BAR","BEL","BLR","BRA","BUL","CAN","CHI","CHN","COL","CRO","CYP","CZE","DEN","ECU","ESP","EST","FIN","FRA","GBR","GEO","GER","GRE","HKG","HUN","IRL","ISR","ITA","JPN","KAZ","KOR","LAT","LTU","MDA","MKD","MNE","NED","NOR","NZL","POL","POR","PRK","ROU","RSA","RUS","SCG","SLO","SRB","SUI","SVK","SWE","TPE","TUR","UKR","URU","USA"],filePrefix:["ar","au","at","az","bb","be","by","br","bg","ca","cl","cn","co","hr","cy","cz","dk","ec","es","ee","fi","fr","gb","ge","de","gr","hk","hu","ie","il","it","jp","kg","kr","lv","lt","md","mk","me","nl","no","nz","pl","pt","kp","ro","za","ru","xx","si","rs","ch","sk","se","tw","tr","ua","uy","us"],getFlagFile:function(a){var b,c;return c="xx",b=this.abbrevList.indexOf(a),-1!==b&&(c=this.filePrefix[b]),wocdb.config.url+"img/"+c+".png"},hijackLinks:function(){$(document).on("click","a[href]:not([data-bypass])",function(a){var b,c;b={prop:$(this).prop("href"),attr:$(this).attr("href")},c=location.protocol+"//"+location.host+"/wocdb",b.prop.slice(0,c.length)===c&&(a.preventDefault(),wocdb.router.navigate(b.attr,!0))})}};wocdb.utils=a}(),function(){"use strict";wocdb.PersonView=Backbone.View.extend({el:"#person-page",events:{"click #person-table tbody tr":"selectWOCRace"},headerTemplate:_.template($("#person-header-tmpl").html()),initialize:function(){this.listenTo(this.collection,"update",this.render),wocdb.dispatcher.on("startup:person",this.render,this)},render:function(){this.personTable&&this.personTable.destroy(),this.$("#person-header").empty().html(this.headerTemplate(this.collection.models[0].attributes)),this.personTable=$("#person-table").empty().DataTable({data:this.collection.models,paging:!1,info:!1,columns:[{data:function(a){return a.get("year")},title:"Year"},{data:function(a){return wocdb.utils.getType(a.get("wocid"))},title:"Event"},{data:function(a){return wocdb.utils.getVenue(a.get("wocid"))},title:"Venue"},{data:function(a){return a.get("class")},title:"Class"},{data:function(a){return a.get("race")},title:"Race"},{data:function(a){return 999===a.get("position")?"-":a.get("position")},title:"Place"},{data:function(a){return a.get("name")},title:"Name"},{data:function(a){return a.get("country")},title:"Country"},{data:function(a){return"<img src='"+a.get("flag")+"'>"},title:""},{data:function(a){return a.get("time")},title:"Time"}],createdRow:function(a,b){$(a).attr("wocid",b.attributes.wocid).attr("raceid",b.attributes.raceid)},order:[[0,"desc"],[1,"desc"]],autoWidth:!0,searching:!1,columnDefs:[{className:"dt-center",targets:[0,1,5,7,9]}]})},selectWOCRace:function(a){var b,c;wocdb.dispatcher.trigger("display:page","single-woc-page"),b=parseInt($(a.currentTarget).attr("wocid"),10),c=parseInt($(a.currentTarget).attr("raceid"),10),wocdb.dispatcher.trigger("click:showWOCID",{wocid:b,raceid:c})}})}(),function(){"use strict";wocdb.RaceResultView=Backbone.View.extend({el:"#result-table",events:{"click tr":"selectPerson"},initialize:function(){this.listenTo(this.collection,"update",this.render),wocdb.dispatcher.on("startup:race",this.render,this)},render:function(){var a,b;if(this.$el.empty().html("<thead><th>Pos</th><th>Name</th><th>Country</th><th></th><th>Time</th><th>% down</th></thead>"),this.collection.length>0)for(a=0;a<this.collection.length;a+=1)b=new wocdb.ResultView({model:this.collection.at(a)}),this.$el.append(b.$el),b.render();else this.$el.append("No records found.");return this.delegateEvents(),this},selectPerson:function(a){var b;wocdb.dispatcher.trigger("display:page","person-page"),b=parseInt(a.currentTarget.id,10),wocdb.dispatcher.trigger("change:person",b)}})}(),function(){"use strict";wocdb.RaceResultHeaderView=Backbone.View.extend({el:"#race-result-header",events:{"click #next-race-at-woc":"showNextRace","click #prev-race-at-woc":"showPreviousRace"},initialize:function(){this.listenTo(this.collection,"update",this.render),wocdb.dispatcher.on("startup:race",this.render,this)},template:_.template($("#race-header-tmpl").html()),render:function(){var a;return this.collection.length&&(a=this.collection.models[0].attributes,document.title=wocdb.utils.getType(a.wocid)+" "+a.year+" "+a["class"]+" "+a.race,$("#race-result-header-text").html(this.template(a))),this},showNextRace:function(){wocdb.dispatcher.trigger("click:showNextRaceAtWOC")},showPreviousRace:function(){wocdb.dispatcher.trigger("click:showPreviousRaceAtWOC")}})}(),function(){"use strict";wocdb.RaceMenuView=Backbone.View.extend({el:"#race-nav-list",events:{},menuTemplate:_.template($("#race-menu-tmpl").html()),initialize:function(){this.listenTo(this.model,"change",this.render),wocdb.dispatcher.on("change:raceid",this.setNewRaceID,this),this.oldRaceID=null},render:function(){var a,b;for(b=this.model.attributes,this.$el.empty(),a=0;a<b.races.length;a+=1)this.$el.append(this.menuTemplate({type:b.type,year:b.year,gender:b.classes[a],race:b.races[a],raceid:b.raceids[a]}));return this.oldRaceID&&this.$("#"+this.oldRaceID).addClass("active"),this},setNewRaceID:function(a){this.oldRaceID&&this.$("#"+this.oldRaceID).removeClass("active"),this.$("#"+a).addClass("active"),this.oldRaceID=a}})}(),function(){"use strict";wocdb.WocdbRouter=Backbone.Router.extend({routes:{wocdb:"showAllWocs","woc/:year/:gender/:race":"getWOCResult","jwoc/:year/:gender/:race":"getJWOCResult","person/:person":"getPerson","*other":"showAllWocs"},getPerson:function(a){this.getPerson(a),wocdb.dispatcher.trigger("display:page","person-page")},getWOCResult:function(a,b,c){this.getResult("WOC",a,b,c)},getJWOCResult:function(a,b,c){this.getResult("JWOC",a,b,c)},getResult:function(a,b,c,d){var e;wocdb.dispatcher.trigger("display:page","single-woc-page"),e=wocdb.races.getRaceID(a,b,c,d),wocdb.raceResult.getResultByRaceID(e)},showAllWocs:function(){document.title="Maprunner WOC Database",wocdb.dispatcher.trigger("display:page","all-wocs-page")}})}(),function(){"use strict";wocdb.Person=Backbone.Collection.extend({initialize:function(){wocdb.dispatcher.on("change:person",this.getPerson,this),this.reset(wocdb.config.bootstrapPerson),this.length>0?this.personid=this.models[0].personid:this.personid=null},url:function(){return wocdb.config.url+"person/"+this.personid},model:wocdb.Result,getPerson:function(a){this.reset(),this.personid=a,wocdb.router.navigate("person/"+this.personid),this.fetch()}})}(),function(){"use strict";wocdb.MasterView=Backbone.View.extend({el:"#wocdb-container",pages:["all-wocs-page","single-woc-page","person-page"],initialize:function(){wocdb.dispatcher.on("display:page",this.setPageVisibility,this)},setPageVisibility:function(a){_.each(this.pages,this.setDisplay,a)},setDisplay:function(a){var b;b=a===this?"block":"none",$("#"+a).css("display",b)}})}();